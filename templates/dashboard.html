{% extends "_base.html" %}
{% block content %}
<h2>Your Dashboard</h2>
<p>Welcome back! Here are your recent applications.</p>
<a href="{{ url_for('apply') }}" class="btn btn-primary mb-3">Start New Home Loan Application</a>
<button class="btn btn-info mb-3" id="checkCibilBtn">Check Your CIBIL Score</button>

<div class="card">
    <div class="card-header">
        Your Applications
    </div>
    <div>
        <a href="{{ url_for('user_logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
    <div class="card-body">
        {% if applications %}
            <ul class="list-group">
                {% for app in applications %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Application #{{ app.id }} ({{ app.created_at.strftime('%Y-%m-%d') }})
                        <span class="badge badge-primary badge-pill">{{ app.status }}</span>
                        <a href="{{ url_for('status', app_id=app.id) }}" class="btn btn-sm btn-secondary">View Details</a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You have not submitted any applications yet.</p>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="cibilModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">CIBIL Score Check</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Checking your CIBIL score...</p>
                <h2 id="cibilScoreResult" class="text-center" style="display:none;"></h2>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        $('#checkCibilBtn').on('click', function() {
            $('#cibilModal').modal('show');
            $('#cibilScoreResult').hide();
            $('#cibilModal .modal-body p').show().text('Checking your CIBIL score...');
            
            $.ajax({
                url: "{{ url_for('check_cibil') }}",
                type: 'POST',
                success: function(response) {
                    setTimeout(function() {
                        $('#cibilModal .modal-body p').hide();
                        $('#cibilScoreResult').text('Your simulated CIBIL Score is: ' + response.cibil_score).show();
                    }, 1500);
                },
                error: function() {
                    $('#cibilModal .modal-body p').text('An error occurred.');
                }
            });
        });
    });
</script>
{% endblock %}